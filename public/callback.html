<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<link rel="apple-touch-icon" sizes="76x76" href="img/apple-icon.png">
	<link rel="icon" type="image/png" sizes="96x96" href="img/favicon.png">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>Callback Page</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <!--     Fonts and icons     -->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
  <link rel='stylesheet' id='eosc-google-fonts-css'
    href='https://fonts.googleapis.com/css?family=Nunito%3A400%2C400i%2C700&#038;display=swap&#038;ver=5.5.1'
    type='text/css' media='all' />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
    integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

</head>
<body>

	<script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script src="https://unpkg.com/vue"></script>
  <div id="test" class="loading-overlay is-active">
    <div>
      <div style="vertical-align: middle;display: flex;">
        <span class="fas fa-spinner fa-5x fa-spin"></span>
        <!-- <p style="padding-left: 10px;text-transform: uppercase;font-weight: 700;margin-bottom: 0px;margin-top: 15px;">
          </p> -->
      </div>
      <div>
    </div>
  </div>
  <script type="text/javascript" src="../src/env.js"></script>
  <script>
        import env from '../src/env';
        const baseUrl = env.provider_url;
        const client_id = env.client_id;
        const groupId = '00gwb2x6jewAvwYSX0h7';
        const redirect_uri = env.redirect_uri;
        const authorize_endpoint = `${baseUrl}authorize`;
        const token_endpoint = `${baseUrl}token`;
        const userinfo_endpoint = `${baseUrl}userinfo`;
        const scope = 'openid profile email eduperson_entitlement';

        const q = new URLSearchParams(location.search);
        var tokens;

        if (q.has('error')) {
          results.innerHTML = q.get('error') + '<br>' + q.get('error_description') + `<br><br>Fix the error and <a href="${redirect_uri}">try again</a>`;
        } else if (q.has('code')) { // If the server returned an authorization code, exchange it for an access token.
          if (localStorage.state == q.get('state')) {
            // getUsers();
            // updateMe();
            getTokens();
            console.log('here')
          } else {
            results.innerHTML = 'Invalid state. <a href="/pkce">retry</a>';
          }

        } else {
          startPkce();
          console.log('here2')
        }

      async function getUsers() {
        tokens = await getTokens();
        history.replaceState({}, null, '/callback.html'); // Remove the auth code from the browser address bar.
        const id_token = JSON.parse(atob(tokens.id_token.split('.')[1]));
        console.log('id_token', id_token);
        const access_token = JSON.parse(atob(tokens.access_token.split('.')[1]));
        console.log('access_token', access_token);
        const options = {
            headers: {Authorization: `Bearer ${tokens.access_token}` }
        };
          const r = await fetch(`${userinfo_endpoint}`, options);
          const users = await r.json();
    }

    async function getGroups() {
      const options = {
              headers: {Authorization: `Bearer ${tokens.access_token}` },
            method: 'post'
      };
            const r = await fetch(`${userinfo_endpoint}`, options);
            if (r.ok) {
        const info = await r.json();
            return info.groups;
      } else {
        return 'error';
      }
    }

    async function makeAdmin(userId, displayName) {
      const options = {
              headers: {Authorization: `Bearer ${tokens.access_token}` },
            method: 'put'
      };
            const r = await fetch(`${baseUrl}/api/v1/groups/${groupId}/users/${userId}`, options);
            results.innerHTML += '<br>' + displayName + ' is now an Admin.';
    }

    async function updateMe() {
                tokens = await getTokens();
              const options = {
                headers: {
                Authorization: `Bearer ${tokens.access_token}`,
              'Content-Type': 'application/json'
        },
              method: 'post',
              body: JSON.stringify({
                profile: {
                lastName: 'Sroka test'
          }
        })
      };
        const r = await fetch(`${baseUrl}/api/v1/users/me`, options);
        console.log(await r.json());
    }

    async function getTokens() {
      const params = {
                grant_type: 'authorization_code',
              code: q.get('code'),
              client_id,
              redirect_uri,
              code_verifier: localStorage.code_verifier
              // code_verifier: 'Gi7fopV0~BaKqIie978fh~xyutU3Qf2eXngJY9lVAEjukZy-KdUUR5DHh2NwpPYfuYOvEL--Ykat387NE4sC1Al30nfXQO6_qEQtMfpLBuNq-UBEJtvTqh-ErLHqxedb'
      };
              const r = await fetch(token_endpoint, {
                method: 'post',
              body: new URLSearchParams(params)
      });
              const tokens = await r.json();
              console.log(tokens)
              const id_token = JSON.parse(atob(tokens.id_token.split('.')[1]));
              console.log('id_token', id_token);
              const access_token = JSON.parse(atob(tokens.access_token.split('.')[1]));
              // localStorage.setItem("session", JSON.stringify({ user: { 'access_token': tokens['access_token'], authenticated: true } }));
              var token_prov = 'eyJraWQiOiJvaWRjIiwiYWxnIjoiUlMyNTYifQ.eyJzdWIiOiI2NmNiYjA1MWRhZDRiNmMzZGFjOGUwY2FiMWQ5YzBhNGMzODhmZDRhNTkzYTczYmEwZjhjYmY2MTU2MTI2MmRiQGVnaS5ldSIsImF6cCI6IjEwMzMzZjA4LTdlOGYtNGNjNC1iYmEwLWU2NmY0ZTU1MDVkMCIsInNjb3BlIjoib3BlbmlkIHByb2ZpbGUiLCJpc3MiOiJodHRwczpcL1wvYWFpLWRldi5lZ2kuZXVcL29pZGNcLyIsImV4cCI6MTYyODY5MTI2MCwiaWF0IjoxNjI4NjA0ODYwLCJqdGkiOiIyODI1NmU0Ni02MDRhLTRlNmMtOTQ3NS1kMTYzNTdlNWEzMGQifQ.D3-28nR0HoojWXYrl4MwnFERyiVM58gZHDZZv6Brf7iVaI1BkhR4bf0XbIm2Fj6A-pdU5jopGWb11fxNfJrylHk1mzITFz8RojO2nWJFhFasxHKjJ3YyGrB7_NcLwowJ36UXxLh_N397GN36Y1SFAAt_UT3QcjeZQDU5X9Ik6l35W4vy10iAOwSvYikYuKk_C-JLsQWBBj3UDvhZ4BzFJdzXdqzEM-DY6OhBDJ_ydPtooQdBEbjsocmVA4MvdW_DEBfNoJrIPyD-NT66T0q5EG5b-7LGbqDAiB_53jZP8JQQSQ2hp1pW6pYRfdc4ELlqB9wnojSkuYQPD2t_t68wwg'
              localStorage.setItem("session", JSON.stringify({ user: { 'access_token': token_prov, authenticated: true } }));
              var url_redirect = window.location.origin + "/#/auth/select-option"
              window.location.href = url_redirect
              // return tokens;
    }

    async function startPkce() {
      const state = generateRandomString();
              const code_verifier = generateRandomString();
              localStorage.state = state;
              localStorage.code_verifier = code_verifier;
              const code_challenge = await pkceChallengeFromVerifier(code_verifier);
              const params = {
                response_type: 'code',
              client_id,
              state,
              scope,
              redirect_uri,
              code_challenge,
              code_challenge_method: 'S256'
      };
              location = authorize_endpoint + '?' + new URLSearchParams(params);
    }


      // PKCE HELPER FUNCTIONS

      // Generate a secure random string using the browser crypto functions.
      function generateRandomString() {
      const array = new Uint32Array(28);
              crypto.getRandomValues(array);
      return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
    }

      async function pkceChallengeFromVerifier(v) {
      const encoder = new TextEncoder();
              const data = encoder.encode(v);
              const hashed = await crypto.subtle.digest('SHA-256', data);
              return base64urlencode(hashed);
    }

    function base64urlencode(str) {
      // Convert the ArrayBuffer to string using Uint8 array to convert to what btoa accepts.
      // btoa accepts chars only within ascii 0-255 and base64 encodes them.
      // Then convert the base64 encoded to base64url encoded
      //   (replace + with -, replace / with _, trim trailing =)
      return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
              .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
  </script>
	<style>
		body {
			/* background: url(img/back-callback.png) no-repeat center center fixed; */
			-webkit-background-size: cover;
			-moz-background-size: cover;
			-o-background-size: cover;
			background-size: cover;
		}
    .loading-overlay {
      display: none;
      background: rgba(255, 255, 255, 0.7);
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      top: 0;
      z-index: 9998;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.is-active {
      display: flex;
    }
	</style>
</body>
</html>
